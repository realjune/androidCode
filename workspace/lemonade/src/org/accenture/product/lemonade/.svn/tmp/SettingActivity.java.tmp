package org.accenture.product.lemonade;

import java.io.InputStream;
import java.util.ArrayList;
import java.util.Vector;

import org.accenture.product.lemonade.content.IconDataBaseAdapter;
import org.accenture.product.lemonade.content.WallpapersDateBaseAdapter;
import org.accenture.product.lemonade.model.IconBean;
import org.accenture.product.lemonade.model.LemonadeBean;
import org.accenture.product.lemonade.model.SceneBean;
import org.accenture.product.lemonade.model.WallpapersBean;
import org.accenture.product.lemonade.receiver.IconReceiver;
import org.accenture.product.lemonade.receiver.SceneReceiver;
import org.accenture.product.lemonade.receiver.WallpapersReceiver;
import org.accenture.product.lemonade.util.MyImg;
import org.accenture.product.lemonade.util.ResourcesUtil;

import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.drawable.BitmapDrawable;
import android.os.Bundle;
import android.util.Log;
import android.view.Gravity;
import android.view.View;
import android.view.ViewGroup;
import android.view.Window;
import android.view.animation.AnimationUtils;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemSelectedListener;
import android.widget.BaseAdapter;
import android.widget.Button;
import android.widget.Gallery;
import android.widget.Gallery.LayoutParams;
import android.widget.ImageSwitcher;
import android.widget.ImageView;
import android.widget.Toast;
import android.widget.ViewSwitcher.ViewFactory;

public class SettingActivity extends Activity implements OnItemSelectedListener, ViewFactory
{

	private ImageSwitcher mSwitcher;
	private Gallery setting_gallery;
	private Button apply;

	// private Integer[] mThumbIds =
	// { R.drawable.moka1, R.drawable.moka2, R.drawable.moka3, R.drawable.moka4,
	// R.drawable.moka5, };
	//
	// private Integer[] mImageIds =
	// { R.drawable.moka1, R.drawable.moka2, R.drawable.moka3, R.drawable.moka4,
	// R.drawable.moka5, };

	// private PackageManager mPackageManager;
	// private static final String LOG_TAG = "LiveWallpapersPicker";

	private ArrayList<Bitmap> mThumbnails = new ArrayList<Bitmap>();
	private ArrayList<Bitmap> mPic = new ArrayList<Bitmap>();

	private String TAG = "SettingActivity";

	private int type;

	private static final String WALLPAPER_ACTION = "org.accenture.product.lemonade.update_wallpapers";
	private static final String ICON_ACTION = "org.accenture.product.lemonade.update_icon";

	@Override
	public void onCreate(Bundle savedInstanceState)
	{
		super.onCreate(savedInstanceState);

		// mPackageManager = getPackageManager();
		// findLiveWallpapers();

		type = getIntent().getIntExtra("type", 0);

		if (type == PersonalizationActivity.WALLPAPER)
		{
			ResourcesUtil resource = ResourcesUtil.getInstance();

			Vector<LemonadeBean> picList = resource.wallPaperList;

			if (picList != null && picList.size() > 0)
			{
				for (int i = 0; i < picList.size(); i++)
				{
					WallpapersBean wallpapersBean = (WallpapersBean) picList.elementAt(i);

					try
					{
						InputStream picIs = getAssets().open(wallpapersBean.get_PagePath());
						BitmapDrawable picDrawable = new BitmapDrawable(picIs);
						Bitmap picBitmap = picDrawable.getBitmap();
						mPic.add(picBitmap);
						picIs.close();

						InputStream thumbIs = getAssets().open(wallpapersBean.get_ThumPath());
						BitmapDrawable thumbDrawable = new BitmapDrawable(thumbIs);
						Bitmap thumbBitmap = thumbDrawable.getBitmap();
						mThumbnails.add(thumbBitmap);
						thumbIs.close();
					}
					catch (Exception e)
					{
						Log.e(TAG, e.toString());
					}
				}
			}
			else
			{
				this.finish();
				Toast toast = Toast.makeText(this, R.string.no_wallpaper_resource, Toast.LENGTH_SHORT);
				toast.setGravity(Gravity.CENTER, 0, 0);
				toast.show();
			}
		}
		else if (type == PersonalizationActivity.SCENE)
		{
			ResourcesUtil resource = ResourcesUtil.getInstance();
			Vector<LemonadeBean> picList = resource.wallPaperList;
			if (picList != null && picList.size() > 0)
			{
				for (int i = 0; i < picList.size(); i++)
				{
					WallpapersBean wallpapersBean = (WallpapersBean) picList.elementAt(i);
					try
					{
						InputStream picIs = getAssets().open(wallpapersBean.get_PagePath());
						BitmapDrawable picDrawable = new BitmapDrawable(picIs);
						Bitmap picBitmap = picDrawable.getBitmap();
						mPic.add(picBitmap);
						picIs.close();

						InputStream thumbIs = getAssets().open(wallpapersBean.get_ThumPath());
						BitmapDrawable thumbDrawable = new BitmapDrawable(thumbIs);
						Bitmap thumbBitmap = thumbDrawable.getBitmap();
						mThumbnails.add(thumbBitmap);
						thumbIs.close();
					}
					catch (Exception e)
					{
						Log.e(TAG, e.toString());
					}
				}
			}
			else
			{
				this.finish();
				Toast toast = Toast.makeText(this, R.string.no_scene_resource, Toast.LENGTH_SHORT);
				toast.setGravity(Gravity.CENTER, 0, 0);
				toast.show();
			}
		}
		else if (type == PersonalizationActivity.ICON)
		{
			ResourcesUtil resource = ResourcesUtil.getInstance();

			Vector<LemonadeBean> iconList = resource.iconList;
			if (iconList != null)
			{
				for (int i = 0; i < iconList.size(); i++)
				{
					IconBean iconBean = (IconBean) iconList.elementAt(i);
					try
					{
						InputStream picIs = getAssets().open(iconBean.get_PagePath());
						BitmapDrawable picDrawable = new BitmapDrawable(picIs);
						Bitmap picBitmap = picDrawable.getBitmap();
						mPic.add(picBitmap);
						picIs.close();

						InputStream thumbIs = getAssets().open(iconBean.get_ThumPath());
						BitmapDrawable thumbDrawable = new BitmapDrawable(thumbIs);
						Bitmap thumbBitmap = thumbDrawable.getBitmap();
						mThumbnails.add(thumbBitmap);
						thumbIs.close();
					}
					catch (Exception e)
					{
						Log.e(TAG, e.toString());
					}
				}
			}
			else
			{

			}
		}

		requestWindowFeature(Window.FEATURE_NO_TITLE);
		setContentView(R.layout.setting);

		mSwitcher = (ImageSwitcher) findViewById(R.id.switcher);
		mSwitcher.setFactory(this);
		mSwitcher.setInAnimation(AnimationUtils.loadAnimation(this, android.R.anim.fade_in));
		mSwitcher.setOutAnimation(AnimationUtils.loadAnimation(this, android.R.anim.fade_out));

		setting_gallery = (Gallery) findViewById(R.id.setting_gallery);
		setting_gallery.setAdapter(new ImageAdapter(this));
		setting_gallery.setOnItemSelectedListener(this);

		apply = (Button) findViewById(R.id.setting_apply);

		apply.setOnClickListener(new View.OnClickListener()
		{

			@Override
			public void onClick(View v)
			{
				// 发送广播
				if (type == PersonalizationActivity.WALLPAPER)
				{
					int index = setting_gallery.getSelectedItemPosition();
					WallpapersBean wallpapersBean = (WallpapersBean) ResourcesUtil.getInstance().wallPaperList.elementAt(index);
					// WallpapersDateBaseAdapter
					// adapter=WallpapersDateBaseAdapter.getInstance();
					// adapter.open();
					// adapter.update(wallpapersBean);
					// adapter.close();

					Intent intent = new Intent();
					intent.setAction(WALLPAPER_ACTION);
					intent.putExtra(WallpapersReceiver.EXTRAS_KEY, wallpapersBean);

					finish();

					sendBroadcast(intent);
				}
				else if (type == PersonalizationActivity.SCENE)
				{
					int index = setting_gallery.getSelectedItemPosition();

					SceneBean sceneBean = new SceneBean();
					sceneBean.setId(index + 1);
					sceneBean.setUse(true);
					Intent intent = new Intent();
					intent.setAction(SceneReceiver.UPDATE_SCENE);
					intent.putExtra(SceneReceiver.EXTRAS_KEY, sceneBean);

//					finish();

					sendBroadcast(intent);
					
					Intent goToScreen=new Intent(SettingActivity.this,Launcher.class);
					startActivity(goToScreen);
				}
				else if (type == PersonalizationActivity.ICON)
				{

					int index = setting_gallery.getSelectedItemPosition();
					IconBean iconBean = (IconBean) ResourcesUtil.getInstance().iconList.elementAt(index);

					IconDataBaseAdapter adapter = IconDataBaseAdapter.getInstance();
					adapter.open();
					adapter.update(iconBean);
					adapter.close();

					Intent intent = new Intent();
					intent.setAction(ICON_ACTION);
					intent.putExtra(IconReceiver.EXTRAS_KEY, iconBean);

					finish();

					sendBroadcast(intent);
				}

			}
		});

	}

	public class ImageAdapter extends BaseAdapter
	{
		public ImageAdapter(Context c)
		{
			mContext = c;
		}

		public int getCount()
		{
			return mThumbnails.size();
		}

		public Object getItem(int position)
		{
			return position;
		}

		public long getItemId(int position)
		{
			return position;
		}

		public View getView(int position, View convertView, ViewGroup parent)
		{

			ImageView i = new ImageView(mContext);
			i.setScaleType(ImageView.ScaleType.CENTER_INSIDE);
			// Resources re = mContext.getResources();
			// InputStream is = re.openRawResource(mThumbnails.get(position));
			// BitmapDrawable mapdraw = new BitmapDrawable(is);
			// Bitmap bitmap = mapdraw.getBitmap();
			// mThumbnails.get(position)
			// Drawable drawable=mThumbnails.get(position);
			// Bitmap bitmap = ((BitmapDrawable)drawable).getBitmap();
			Bitmap bitmap = mThumbnails.get(position);
			i.setImageBitmap(MyImg.createReflectedImage(bitmap));
			// i.setImageDrawable(mThumbnails.get(position));
			i.setAdjustViewBounds(true);
			i.setLayoutParams(new Gallery.LayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.WRAP_CONTENT));
			// i.setBackgroundResource(R.drawable.picture_frame);
			return i;
		}

		private Context mContext;
	}

	@Override
	public void onItemSelected(AdapterView<?> adapter, View v, int position, long id)
	{
		mSwitcher.setImageDrawable(new BitmapDrawable(mPic.get(position)));
	}

	@Override
	public void onNothingSelected(AdapterView<?> arg0)
	{

	}

	@Override
	public View makeView()
	{
		ImageView i = new ImageView(this);
		// i.setBackgroundColor(0xFF000000);
		i.setScaleType(ImageView.ScaleType.CENTER_INSIDE);
		i.setLayoutParams(new ImageSwitcher.LayoutParams(LayoutParams.FILL_PARENT, LayoutParams.FILL_PARENT));
		return i;
	}

	// private void findLiveWallpapers() {
	// List<ResolveInfo> list = mPackageManager.queryIntentServices(
	// new Intent(WallpaperService.SERVICE_INTERFACE),
	// PackageManager.GET_META_DATA);
	//
	// int listSize = list.size();
	//        
	// mThumbnails = new ArrayList<Bitmap>(listSize);
	// mPic=new ArrayList<Bitmap>(listSize);
	//        
	// for (int i = 0; i < listSize; i++) {
	// ResolveInfo resolveInfo = list.get(i);
	// ComponentInfo ci = resolveInfo.serviceInfo;
	// WallpaperInfo info;
	// try {
	// info = new WallpaperInfo(this , resolveInfo);
	// } catch (XmlPullParserException e) {
	// Log.w(LOG_TAG, "Skipping wallpaper " + ci, e);
	// continue;
	// } catch (IOException e) {
	// Log.w(LOG_TAG, "Skipping wallpaper " + ci, e);
	// continue;
	// }
	//            
	// Drawable thumb = info.loadThumbnail(mPackageManager);
	// // Drawable pic=info.loadIcon(mPackageManager);
	// Drawable pic=info.loadThumbnail(mPackageManager);
	//            
	// thumb.setDither(true);
	// pic.setDither(true);
	//            
	// mThumbnails.add(thumb);
	// mPic.add(pic);
	// }
	// }
}